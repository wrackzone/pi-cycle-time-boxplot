<!DOCTYPE html>
<html>
<head>
    <title>pi-cycle-time-boxplot</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function Months(startOn,endBefore,timezone){console.log(startOn,endBefore,timezone);for(var cursor=new Time(startOn).inGranularity(Time.MONTH),end=new Time(endBefore).inGranularity(Time.MONTH),categories=[];cursor.lessThanOrEqual(end);)categories.push(""+cursor),cursor=cursor.add(1);this.categories=categories,this.label="Months",this.field="_ValidTo",this.categorize=function(value){return""+new Time(value._ValidFrom_lastValue,Time.MONTH,timezone).inGranularity(Time.MONTH)}}function Quarters(startOn,endBefore,timezone){for(var cursor=new Time(startOn).inGranularity(Time.QUARTER),end=new Time(endBefore).inGranularity(Time.QUARTER),categories=[];cursor.lessThanOrEqual(end);)categories.push(""+cursor),cursor=cursor.add(1);this.categories=categories,this.label="Quarters",this.field="_ValidTo",this.categorize=function(value){return""+new Time(value._ValidTo_lastValue,Time.QUARTER,timezone).inGranularity(Time.QUARTER)}}function FiscalQuarters(startOn,endBefore,timezone){this.label="Fiscal Quarters",this.field="_ValidTo",this.categorize=function(value){var validToTimeString=value._ValidTo_lastValue||value,calendarQuarter=new Time(validToTimeString,Time.QUARTER,timezone).inGranularity(Time.QUARTER),calendarQuarterStart=calendarQuarter.inGranularity(Time.MONTH),fiscalQuarterStart=calendarQuarterStart.add(1),validTo=new Time(validToTimeString,Time.MONTH,timezone).inGranularity(Time.MONTH),quarter;quarter=validTo.lessThan(fiscalQuarterStart)?calendarQuarter.add(-1):calendarQuarter;var year=""+(quarter.year+1);return"FY"+year.substring(2)+"Q"+quarter.quarter};for(var cursor=new Time(startOn).inGranularity(Time.QUARTER),end=new Time(endBefore).inGranularity(Time.QUARTER),categories=[];cursor.lessThanOrEqual(end);)categories.push(this.categorize(""+cursor)),cursor=cursor.add(1);this.categories=categories}function StoryPoints(){this.categories=["&lt; 1","2","3","5","8","&gt; 8"],this.label="Story Points",this.field="PlanEstimate",this.categorize=function(value){var p=value.PlanEstimate_lastValue;return 1>p?"&lt; 1":2>=p?"2":3>=p?"3":5>=p?"5":8>=p?"8":p>8?"&gt; 8":void 0}}function FeatureSize(preliminaryEstimateValues){this.nameIt=function(value){return _.isUndefined(value)?"Unestimated":value.Name+" ("+value.Value+")"},this.categorize=function(value){var v=_.find(this.values,function(val){return val.ObjectID===value.PreliminaryEstimate_lastValue});return v?this.nameIt(v):"Unestimated"},this.values=preliminaryEstimateValues;var that=this;this.categories=_.map(this.values,function(pev){return that.nameIt(pev)}),this.label="Feature Size",this.field="PreliminaryEstimateValue"}function GroupValueField(typedef){var that=this;that.typedef=typedef,that.label=that.typedef.Name,that.field=that.typedef.ElementName,this.categorize=function(value){return value[that.field+"_lastValue"]}}function Feature(type,beginState,endState,completeState){this.typeHierarchy=type,this.beginState=beginState,this.endState=endState,this.completeState=completeState,this.progressPredicate=function(){return{_TypeHierarchy:this.typeHierarchy,State:{$gte:"No Entry"===this.beginState?null:this.beginState,$lt:this.endState}}},this.completePredicate=function(){return{_TypeHierarchy:this.typeHierarchy,State:{$gte:this.completeState}}}}function HierarchicalRequirement(){var typeHierarchy="HierarchicalRequirement";this.progressPredicate=function(){return{_TypeHierarchy:typeHierarchy,ScheduleState:{$gte:"In-Progress",$lt:"Accepted"},Children:null}},this.completePredicate=function(){return{_TypeHierarchy:typeHierarchy,ScheduleState:{$gte:"Accepted"},Children:null}}}var Lumenize=window.parent.Rally.data.lookback.Lumenize,OLAPCube=Lumenize.OLAPCube,Time=Lumenize.Time,TimeInStateCalculator=Lumenize.TimeInStateCalculator;
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",constructor:function(config){"undefined"!=typeof CustomAppConfig&&Ext.apply(config,CustomAppConfig),this.callParent(arguments)},_onLoad:function(loaded){var that=this;if(console.log("loaded",loaded),this.validate(loaded)){var snapshots=loaded[3],completedOids=loaded[4],groupByFieldName=that.getSetting("GroupByField");if(""!==groupByFieldName&&"PreliminaryEstimate"!==groupByFieldName){var typedef=_.find(loaded[5],function(attr){return attr.Name===that.getSetting("GroupByField")});console.log("typedef",typedef),this._xAxisStrategies.groupByField=new GroupValueField(typedef)}this._xAxisStrategies.featureSize=new FeatureSize(loaded[1]);var tiscResults=this._getTISCResults(snapshots),convertTicksToHours=Ext.bind(function(row){return row.ticks/this._workDayHours},this),getCategory=Ext.bind(function(row){return this._xAxisStrategy.categorize(row)},this),getPreliminaryEstimateValue=Ext.bind(function(row){return that._xAxisStrategies.featureSize.categorize(row)}),getGroupCategory=Ext.bind(function(row){return that._xAxisStrategies.groupByField.categorize(row)}),deriveFieldsOnOutput=Ext.Array.map(this.percentiles,function(percentile){var p=Lumenize.functions.percentileCreator(percentile);return{field:"P"+percentile,f:function(row){var v=p(row.hours_values);return Math.round(100*v)/100}}}),cubeConfig={deriveFieldsOnInput:[{field:"PreliminaryEstimateValue",f:getPreliminaryEstimateValue},{field:"hours",f:convertTicksToHours},{field:"category",f:getCategory}],metrics:[{field:"hours",f:"values"},{field:"hours",f:"average",as:"timeInProcessAverage"}],deriveFieldsOnOutput:deriveFieldsOnOutput,dimensions:[{field:"category"}]};""!==that.getSetting("GroupByField")&&("Preliminary Estimate"===that.getSetting("GroupByField")?cubeConfig.dimensions.push({field:"PreliminaryEstimateValue"}):(cubeConfig.dimensions.push({field:that._xAxisStrategies.groupByField.label}),cubeConfig.deriveFieldsOnInput.push({field:that._xAxisStrategies.groupByField.label,f:getGroupCategory})));var cube=new OLAPCube(cubeConfig),tiscResultsFilteredByCompletion=Ext.Array.filter(tiscResults,function(result){return!!completedOids[result.ObjectID]});console.log("trf",tiscResultsFilteredByCompletion),cube.addFacts(tiscResultsFilteredByCompletion),console.log("cube",cube),this._showChartData(cube)}},validate:function(loaded){var that=this,valid=!0,type=_.find(loaded[0],function(t){return t.TypePath===that.getSetting("PortfolioItemType")});type||(that.add({html:"Invalid type in app settings, should be similar to PortfolioItem/Feature"}),valid=!1),_.each(["BeginState","EndState","CompletedState"],function(state){var stateValue=that.getSetting(state),checkValue=_.find(loaded[2],function(s){return s.Name===stateValue});"No Entry"!==stateValue&&_.isUndefined(checkValue)&&(that.add({html:"Invalid state ("+state+") value:"+stateValue+" for this type"}),valid=!1)});var groupByField=that.getSetting("GroupByField"),groupAttr=_.find(loaded[5],function(attr){return attr.Name===groupByField});return""!==groupByField&&_.isUndefined(groupAttr)&&(that.add({html:"Invalid Group By Field ("+groupByField+")"}),valid=!1),valid},launch:function(){this._workspaceConfig=this.getContext().getWorkspace().WorkspaceConfiguration,this._xAxisStrategies={fiscalQuarter:new FiscalQuarters(this.getStartOn(),this.getEndBefore(),this._workspaceConfig.TimeZone),month:new Months(this.getStartOn(),this.getEndBefore(),this._workspaceConfig.TimeZone),storyPoints:new StoryPoints,quarter:new Quarters(this.getStartOn(),this.getEndBefore(),this._workspaceConfig.TimeZone)},this._xAxisStrategy=this._xAxisStrategies[this.getSetting("ShowMonths")===!0?"month":"quarter"],this._typeStrategy=new Feature(this.getSetting("PortfolioItemType"),this.getSetting("BeginState"),this.getSetting("EndState"),this.getSetting("CompletedState")),Deft.Promise.all([this._getPortfolioItemTypes(),this._getPreliminaryEstimateValues(),this._getPortfolioItemStates(),this._getTISCSnapshots(),this._getCompletedOids(),this._getPortfolioItemAttributes()]).then({success:Ext.bind(this._onLoad,this)})},_getPortfolioItemTypes:function(){var deferred=new Deft.Deferred;return Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:"TypeDefinition",fetch:["Name","ObjectID","TypePath","Attributes"],filters:[{property:"Ordinal",operator:">=",value:0}],listeners:{scope:this,load:function(store,data){var recs=_.map(data,function(d){return d.data});deferred.resolve(recs)}}}),deferred.getPromise()},_getPortfolioItemAttributes:function(){var that=this,type=that.getSetting("PortfolioItemType"),deferred=new Deft.Deferred;return Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:"TypeDefinition",fetch:["Attributes"],filters:[{property:"TypePath",operator:"contains",value:type}],listeners:{scope:this,load:function(store,data){_.first(data).getCollection("Attributes").load({fetch:["Name","RealAttributeType","Type","ElementName"],callback:function(records,operation,success){var recs=_.map(records,function(d){return d.data});deferred.resolve(recs)}})}}}),deferred.getPromise()},_getPortfolioItemStates:function(){var that=this,type=that.getSetting("PortfolioItemType"),deferred=new Deft.Deferred;return Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:"State",fetch:!0,filters:[{property:"TypeDef.TypePath",operator:"contains",value:type}],sorters:[{property:"OrderIndex",direction:"ASC"}],listeners:{scope:this,load:function(store,data){var recs=_.map(data,function(d){return d.data});deferred.resolve(recs)}}}),deferred.getPromise()},_getPreliminaryEstimateValues:function(){var deferred=new Deft.Deferred;return Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:"PreliminaryEstimate",fetch:["Name","ObjectID","Value"],filters:[],listeners:{scope:this,load:function(store,data){var recs=_.map(data,function(d){return d.data});deferred.resolve(recs)}}}),deferred.getPromise()},_getTISCSnapshots:function(){var query=this._getProjectScopedQuery(Ext.merge({_ValidFrom:{$gte:this.getStartOn(),$lt:this.getEndBefore()}},this._typeStrategy.progressPredicate())),deferred=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(store){for(var snapshots=[],i=0,ii=store.getTotalCount();ii>i;++i)snapshots.push(store.getAt(i).data);deferred.resolve(snapshots)}},fetch:["ObjectID","_ValidTo","_ValidFrom","PreliminaryEstimate","LeafStoryPlanEstimateTotal","c_LOB"].concat(this._xAxisStrategy.field),find:query}),deferred.getPromise()},_getProjectScopedQuery:function(query){return Ext.merge({_ProjectHierarchy:{$in:[Number(this.getContext().getProject().ObjectID)]}},query)},_getCompletedOids:function(type,afterCompletedOIDs){var deferred=new Deft.Deferred;return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{refresh:function(store){var completedOids={};store.each(function(model){completedOids[model.data.ObjectID]=!0}),deferred.resolve(completedOids)}},fetch:["ObjectID"],find:this._getProjectScopedQuery(Ext.merge({__At:this.getEndBefore()},this._typeStrategy.completePredicate()))}),deferred.getPromise()},_getTISCResults:function(snapshots){var config={granularity:"hour",tz:this._workspaceConfig.TimeZone,workDays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],endBefore:this.getEndBefore(),workDayStartOn:{hour:9,minute:0},workDayEndBefore:{hour:17,minute:0},trackLastValueForTheseFields:[this._xAxisStrategy.field,"_ValidFrom",this._xAxisStrategies.groupByField.field]},startOnInMinutes=60*config.workDayStartOn.hour+config.workDayStartOn.minute,endBeforeInMinutes=60*config.workDayEndBefore.hour+config.workDayEndBefore.minute;endBeforeInMinutes>startOnInMinutes?workMinutes=endBeforeInMinutes-startOnInMinutes:(workMinutes=1440-startOnInMinutes,workMinutes+=endBeforeInMinutes),this._workDayHours=workMinutes/60;var tisc=new TimeInStateCalculator(config);tisc.addSnapshots(snapshots,this.getStartOn(),this.getEndBefore());var results=tisc.getResults();return results},getTitle:function(){return"Time In Process ["+this.getSetting("BeginState")+","+this.getSetting("EndState")+"]"},_showChartData:function(cube){var that=this,makeKey=function(catField,cat,xField,xValue){var obj={};return _.isNull(cat)||(obj[catField]=cat),_.isNull(xValue)||(obj[xField]=xValue),obj},makePoint=function(cube,key){var keys=_.map(that.percentiles,function(p){return"P"+p}),v=cube.getCell(key);if(_.isUndefined(v))return null;var dataObj=_.zipObject(["low","q1","median","q3","high"],_.map(keys,function(k){return v[k]}));return dataObj._count=v._count,dataObj},catField=_.first(cube.config.dimensions).field,xField=_.last(cube.config.dimensions).field,categories=cube.getDimensionValues(catField),xvalues=cube.config.dimensions.length>1?cube.getDimensionValues(xField):[],series=null;series=cube.config.dimensions.length>1?_.map(xvalues,function(xvalue){return{name:xvalue,data:_.map(categories,function(cat){return makePoint(cube,makeKey(catField,cat,xField,xvalue))}),tooltip:{headerFormat:"{point.point._count} records<br/>"}}}):[{name:catField,data:_.map(categories,function(cat){return makePoint(cube,makeKey(catField,cat,null,null))}),tooltip:{headerFormat:"{point.point._count} records<br/>"}}];var chart=this.down("#chart1");chart&&chart.removeAll(),this._extChart=Ext.create("Rally.ui.chart.Chart",{height:500,chartData:{categories:categories,series:series},chartConfig:{chart:{type:"boxplot"},title:{text:this.getTitle()},xAxis:{tickInterval:1,title:{text:this._xAxisStrategy.label}},yAxis:[{title:{text:"Time in Process (days)"},plotLines:[{value:0,width:1,color:"#808080"}]}],legend:{align:"center",verticalAlign:"bottom"}}}),chart.add(this._extChart),this._extChart._unmask()},config:{startOn:""+new Time(new Date).inGranularity(Time.MONTH).add(-6),endBefore:""+new Time(new Date).inGranularity(Time.MONTH).add(0),xAxis:"month",type:"PortfolioItem/Feature",defaultSettings:{NumberPeriods:6,ShowMonths:!0,PortfolioItemType:"PortfolioItem/Feature",BeginState:"Prioritized",EndState:"Deployed",CompletedState:"Deployed",GroupByField:"LOB"}},getSettingsFields:function(){var values=[{name:"NumberPeriods",xtype:"rallytextfield",label:"Number of time periods to report on eg. 6"},{name:"ShowMonths",xtype:"rallycheckboxfield",label:"True for months (otherwise quarters)"},{name:"PortfolioItemType",xtype:"rallytextfield",label:"Name of the type eg. PortfolioItem/Initiative"},{name:"BeginState",xtype:"rallytextfield",label:"Name of the beginning state the cycle time is calculated for"},{name:"EndState",xtype:"rallytextfield",label:"Name of the end state the cycle time is calculated for"},{name:"CompletedState",xtype:"rallytextfield",label:"Name of the state which signifies the item is completed and should be reported on"},{name:"GroupByField",xtype:"rallytextfield",label:"Field to group the results by eg. PreliminaryEstimate"}];return _.each(values,function(value){value.labelWidth=250,value.labelAlign="left"}),values},percentiles:[1,25,50,75,99],items:[{xtype:"container",itemId:"chart1",columnWidth:1}]});

            Rally.launchApp('CustomApp', {
                name:"pi-cycle-time-boxplot",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
