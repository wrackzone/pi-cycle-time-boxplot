<!DOCTYPE html>
<html>
<head>
    <title>pi-cycle-time-boxplot</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                
//Get reference to Lumenize
var Lumenize = window.parent.Rally.data.lookback.Lumenize,
    OLAPCube = Lumenize.OLAPCube,
    Time = Lumenize.Time,
    TimeInStateCalculator = Lumenize.TimeInStateCalculator;

function Months(startOn, endBefore, timezone) {
    var cursor = new Time(startOn).inGranularity(Time.MONTH),
        end = new Time(endBefore).inGranularity(Time.MONTH),
        categories = [];

    while (cursor.lessThanOrEqual(end)) {
        categories.push(cursor.toString());
        cursor = cursor.add(1);
    }

    this.categories = categories;
    this.label = 'Months';
    this.field = '_ValidTo';

    this.categorize = function(value) {
        return new Time(value._ValidTo_lastValue, Time.MONTH, timezone).inGranularity(Time.MONTH).toString();
    };
}

function Quarters(startOn, endBefore, timezone) {
    var cursor = new Time(startOn).inGranularity(Time.QUARTER),
        end = new Time(endBefore).inGranularity(Time.QUARTER),
        categories = [];

    while (cursor.lessThanOrEqual(end)) {
        categories.push(cursor.toString());
        cursor = cursor.add(1);
    }

    this.categories = categories;
    this.label = 'Quarters';
    this.field = '_ValidTo';

    this.categorize = function(value) {
        return new Time(value._ValidTo_lastValue, Time.QUARTER, timezone).inGranularity(Time.QUARTER).toString();
    };
}

function FiscalQuarters(startOn, endBefore, timezone) {
    this.label = 'Fiscal Quarters';
    this.field = '_ValidTo';

    this.categorize = function(value) {
        var validToTimeString = value._ValidTo_lastValue || value;

        //Assumes fiscal quarters are offset 1 month (in the future) from calendar quarters
        //The algorithm goes like this:
        // 1) Find the calendar quarter of the validToTimeString
        // 2) Find the start month of the calendar quarter
        // 3) Add 1 month to the start month of the calendar quarter to find
        //    the start month of the fiscal quarter.
        // 4) If the validTo time (in month granularity) is less than the start
        //    of the fiscal quarter, go back to the previous calendar quarter,
        //    otherwise use the calendar quarter we found in step 1.
        // 5) Format the calendar quarter as a fiscal quarter.
        var calendarQuarter = new Time(validToTimeString, Time.QUARTER, timezone).inGranularity(Time.QUARTER);
        var calendarQuarterStart = calendarQuarter.inGranularity(Time.MONTH);
        var fiscalQuarterStart = calendarQuarterStart.add(1);
        var validTo = new Time(validToTimeString, Time.MONTH, timezone).inGranularity(Time.MONTH);

        var quarter;
        if (validTo.lessThan(fiscalQuarterStart)) {
            quarter = calendarQuarter.add(-1);
        } else {
            quarter = calendarQuarter;
        }

        var year = (quarter.year + 1).toString();
        return 'FY' + year.substring(2) + 'Q' + quarter.quarter;
    };

    var cursor = new Time(startOn).inGranularity(Time.QUARTER),
        end = new Time(endBefore).inGranularity(Time.QUARTER),
        categories = [];

    while (cursor.lessThanOrEqual(end)) {
        categories.push(this.categorize(cursor.toString()));
        cursor = cursor.add(1);
    }

    this.categories = categories;
}

function StoryPoints() {

    this.categories = ['&lt; 1', '2', '3', '5', '8', '&gt; 8'];
    this.label = 'Story Points';
    this.field = 'PlanEstimate';

    this.categorize = function(value) {
        var p = value.PlanEstimate_lastValue;
        if (p < 1) {
            return '&lt; 1';
        } else if (p <= 2) {
            return '2';
        } else if (p <= 3) {
            return '3';
        } else if (p <= 5) {
            return '5';
        } else if (p <= 8) {
            return '8';
        } else if (p > 8) {
            return '&gt; 8';
        }
    };
}

function FeatureSize() {
    this.categories = ['Extra Small', 'Small', 'Medium', 'Large', 'Extra Large', 'Unestimated'];
    this.label = 'Feature Size';
    this.field = 'PreliminaryEstimate';

    var sizes = {
        4484657773: 'Extra Small',
        4484657774: 'Small',
        4484657775: 'Medium',
        4484657776: 'Large',
        4484657777: 'Extra Large'
    };

    this.categorize = function(value) {
        return sizes[value.PreliminaryEstimate_lastValue] || 'Unestimated';
    };
}

function Feature() {
    var typeHierarchy = 'PortfolioItem/Feature';
    this.progressPredicate = function() {
        return {
            // Features in development and < 100 % done
            '_TypeHierarchy': typeHierarchy,
            'State': {
                '$gte': 'Prep',
                '$lt': 'In Dev'
            }
        };
    };
    this.completePredicate = function() {
        return {
            // Features not in development anymore or >= 100% done
            '_TypeHierarchy': typeHierarchy,
            'State': {
                '$gte': 'In Dev'
            }
        };
    };
}

function HierarchicalRequirement() {
    var typeHierarchy = 'HierarchicalRequirement';
    this.progressPredicate = function() {
        return {
            // Leaf stories in progress
            '_TypeHierarchy': typeHierarchy,
            'ScheduleState': {
                '$gte': 'In-Progress',
                '$lt': 'Accepted'
            },
            'Children': null
        };
    };
    this.completePredicate = function() {
        return {
            // Leaf stories accepted
            '_TypeHierarchy': typeHierarchy,
            'ScheduleState': {
                '$gte': 'Accepted'
            },
            'Children': null
        };
    };
}
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    constructor: function(config) {
        if (typeof(CustomAppConfig) !== 'undefined') {
            Ext.apply(config, CustomAppConfig);
        }
        this.callParent(arguments);

        this._workspaceConfig = this.getContext().getWorkspace().WorkspaceConfiguration;

        this._xAxisStrategies = {
            'fiscalQuarter': new FiscalQuarters(this.getStartOn(), this.getEndBefore(), this._workspaceConfig.TimeZone),
            'month': new Months(this.getStartOn(), this.getEndBefore(), this._workspaceConfig.TimeZone),
            'storyPoints': new StoryPoints(),
            'featureSize': new FeatureSize(),
            'quarter': new Quarters(this.getStartOn(), this.getEndBefore(), this._workspaceConfig.TimeZone)
        };
    },
    
    launch: function() {
        //Write app code here

        //API Docs: https://help.rallydev.com/apps/2.0/doc/
    },
    
    config: {
        startOn: '2014-10',
        endBefore: new Time(new Date()).inGranularity(Time.MONTH).add(3).toString(),
        xAxis: 'month',
        type: 'PortfolioItem/Feature',

        defaultSettings : {
            NumberPeriods : 6,
            ShowMonths : true,
            PortfolioItemType : "PortfolioItem/Feature",
            BeginState : "",
            EndState : "",
            CompletedState : "",
            GroupByField : ""
        }
    },
	
	getSettingsFields: function() {

        var values = [
            {
                name: 'NumberPeriods',
                xtype: 'rallytextfield',
                label: 'Number of time periods to report on eg. 6'
            },
            {
                name: 'ShowMonths',
                xtype: 'rallycheckboxfield',
                label: 'True for months (otherwise quarters)'
            },
            {
                name: 'PortfolioItemType',
                xtype: 'rallytextfield',
                label: 'Name of the type eg. PortfolioItem/Initiative'
            },
            {
                name: 'BeginState',
                xtype: 'rallytextfield',
                label: 'Name of the beginning state the cycle time is calculated for'
            },
            {
                name: 'EndState',
                xtype: 'rallytextfield',
                label: 'Name of the end state the cycle time is calculated for'
            },
            {
                name: 'CompletedState',
                xtype: 'rallytextfield',
                label: 'Name of the state which signifies the item is completed and should be reported on'
            },
            {
                name: 'GroupByField',
                xtype: 'rallytextfield',
                label: 'Field to group the results by eg. PreliminaryEstimate'
            },
		];
        _.each(values,function(value){
            value.labelWidth = 250;
            value.labelAlign = 'left'
        });
        return value;
	}

});


            Rally.launchApp('CustomApp', {
                name:"pi-cycle-time-boxplot",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
